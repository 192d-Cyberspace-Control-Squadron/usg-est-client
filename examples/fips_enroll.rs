// SPDX-License-Identifier: Apache-2.0
// Copyright 2025 U.S. Federal Government (in countries where recognized)

//! FIPS 140-2 Compliant Certificate Enrollment Example
//!
//! This example demonstrates certificate enrollment using FIPS-validated cryptography.
//!
//! # Requirements
//!
//! - OpenSSL 3.0+ with FIPS module installed and configured
//! - FIPS mode enabled system-wide (via openssl.cnf)
//! - EST server that supports FIPS-approved algorithms
//!
//! # Running
//!
//! ```bash
//! cargo run --example fips_enroll --features fips,csr-gen -- --server https://est.example.mil
//! ```
//!
//! # FIPS Mode Setup
//!
//! See docs/fips-compliance.md for detailed setup instructions.

#![cfg(all(feature = "fips", feature = "csr-gen"))]

use std::process;
use usg_est_client::csr::CsrBuilder;
use usg_est_client::fips::{enable_fips_mode, fips_module_info, FipsConfig};
use usg_est_client::{EnrollmentResponse, EstClient, EstClientConfig};

#[tokio::main]
async fn main() {
    // Parse command-line arguments
    let args: Vec<String> = std::env::args().collect();
    let server_url = if args.len() > 2 && args[1] == "--server" {
        &args[2]
    } else {
        eprintln!("Usage: {} --server <EST_SERVER_URL>", args[0]);
        eprintln!("Example: {} --server https://est.example.mil", args[0]);
        process::exit(1);
    };

    println!("=== FIPS 140-2 Compliant EST Certificate Enrollment ===\n");

    // Step 1: Check FIPS module status
    println!("Step 1: Checking FIPS module status...");
    let info = fips_module_info();
    println!("{}", info);

    if !info.fips_capable {
        eprintln!("\n‚ùå ERROR: OpenSSL FIPS module is not available");
        eprintln!("Please install OpenSSL 3.0+ with FIPS module");
        eprintln!("See docs/fips-compliance.md for setup instructions");
        process::exit(1);
    }

    if !info.fips_enabled {
        println!("\n‚ö†Ô∏è  FIPS mode is not currently enabled. Attempting to enable...");
        match enable_fips_mode() {
            Ok(()) => println!("‚úÖ FIPS mode enabled successfully"),
            Err(e) => {
                eprintln!("\n‚ùå ERROR: Failed to enable FIPS mode: {}", e);
                eprintln!("You may need to configure OpenSSL system-wide");
                eprintln!("See docs/fips-compliance.md for setup instructions");
                process::exit(1);
            }
        }
    } else {
        println!("‚úÖ FIPS mode is already enabled");
    }

    // Step 2: Create FIPS configuration
    println!("\nStep 2: Creating FIPS configuration...");
    let fips_config = match FipsConfig::builder()
        .enforce_fips_mode(true) // Require FIPS mode
        .min_rsa_key_size(2048) // FIPS minimum
        .min_ecc_key_size(256) // FIPS minimum (P-256)
        .block_non_fips_algorithms(true) // Block weak algorithms
        .require_tls_12_minimum(true) // Require TLS 1.2+
        .build()
    {
        Ok(config) => {
            println!("‚úÖ FIPS configuration created:");
            println!("   - Enforce FIPS mode: true");
            println!("   - Min RSA key size: 2048 bits");
            println!("   - Min ECC key size: 256 bits (P-256)");
            println!("   - Block non-FIPS algorithms: true");
            println!("   - Require TLS 1.2+: true");
            config
        }
        Err(e) => {
            eprintln!("\n‚ùå ERROR: Failed to create FIPS configuration: {}", e);
            process::exit(1);
        }
    };

    // Step 3: Create EST client configuration
    println!("\nStep 3: Creating EST client configuration...");
    let est_config = match EstClientConfig::builder()
        .server_url(server_url)
        .and_then(|b| b.build())
    {
        Ok(mut config) => {
            config.fips_config = Some(fips_config);
            println!("‚úÖ EST client configured:");
            println!("   - Server URL: {}", config.server_url);
            println!("   - FIPS mode: enabled");
            config
        }
        Err(e) => {
            eprintln!("\n‚ùå ERROR: Invalid server URL: {}", e);
            process::exit(1);
        }
    };

    // Step 4: Create EST client
    println!("\nStep 4: Creating EST client...");
    let client = match EstClient::new(est_config).await {
        Ok(client) => {
            println!("‚úÖ EST client created successfully");
            client
        }
        Err(e) => {
            eprintln!("\n‚ùå ERROR: Failed to create EST client: {}", e);
            process::exit(1);
        }
    };

    // Step 5: Get CA certificates
    println!("\nStep 5: Retrieving CA certificates...");
    let ca_certs = match client.get_ca_certs().await {
        Ok(certs) => {
            println!("‚úÖ Retrieved {} CA certificate(s)", certs.len());
            for (i, cert) in certs.iter().enumerate() {
                println!("   Certificate {}: {} bytes (DER)", i + 1, cert.len());
            }
            certs
        }
        Err(e) => {
            eprintln!("\n‚ùå ERROR: Failed to retrieve CA certificates: {}", e);
            eprintln!("   This may indicate:");
            eprintln!("   - EST server is not reachable");
            eprintln!("   - Server does not support FIPS-approved TLS ciphers");
            eprintln!("   - Network connectivity issues");
            process::exit(1);
        }
    };

    // Step 6: Generate FIPS-compliant CSR
    println!("\nStep 6: Generating FIPS-compliant Certificate Signing Request...");
    println!("   Using RSA-2048 (FIPS-approved)");

    let (csr_der, _key_pair) = match CsrBuilder::new()
        .common_name("fips-device.example.mil")
        .organization("U.S. Department of Defense")
        .organizational_unit("Test Unit")
        .country("US")
        .san_dns("fips-device.example.mil")
        .build()
    {
        Ok((csr, key)) => {
            println!("‚úÖ CSR generated successfully:");
            println!("   - Subject: CN=fips-device.example.mil");
            println!("   - Organization: U.S. Department of Defense");
            println!("   - Key Algorithm: RSA-2048 (FIPS-approved)");
            println!("   - Signature Algorithm: SHA-256 with RSA (FIPS-approved)");
            println!("   - CSR size: {} bytes (DER)", csr.len());
            (csr, key)
        }
        Err(e) => {
            eprintln!("\n‚ùå ERROR: Failed to generate CSR: {}", e);
            process::exit(1);
        }
    };

    // Step 7: Enroll for certificate
    println!("\nStep 7: Enrolling for certificate...");
    println!("   Sending CSR to EST server: {}", server_url);

    match client.simple_enroll(&csr_der).await {
        Ok(EnrollmentResponse::Issued { certificate }) => {
            println!("\n‚úÖ SUCCESS: Certificate issued!");
            println!("   Certificate size: {} bytes (DER)", certificate.len());
            println!("   Certificate chain includes {} certificate(s)", ca_certs.len());
            println!("\nüéâ FIPS-compliant certificate enrollment completed successfully!");
            println!("\nNext steps:");
            println!("1. Save the issued certificate and private key");
            println!("2. Install certificate in system certificate store");
            println!("3. Configure applications to use the certificate");
            println!("4. Verify certificate with: openssl x509 -in cert.pem -text -noout");
        }
        Ok(EnrollmentResponse::Pending { retry_after }) => {
            println!("\n‚è≥ Certificate enrollment is pending manual approval");
            println!("   Retry after: {} seconds", retry_after);
            println!("\nNext steps:");
            println!("1. Wait for administrator approval");
            println!("2. Retry enrollment after {} seconds", retry_after);
            println!("3. Check with EST server administrator for approval status");
        }
        Err(e) => {
            eprintln!("\n‚ùå ERROR: Certificate enrollment failed: {}", e);
            eprintln!("   This may indicate:");
            eprintln!("   - Server requires authentication (HTTP Basic or TLS client cert)");
            eprintln!("   - CSR validation failed");
            eprintln!("   - Server policy violation");
            eprintln!("   - FIPS algorithm mismatch");
            process::exit(1);
        }
    }

    println!("\n=== FIPS Compliance Summary ===");
    println!("‚úÖ All cryptographic operations used FIPS-validated modules");
    println!("‚úÖ Only FIPS-approved algorithms were used:");
    println!("   - TLS: TLS 1.2+ (FIPS-compliant)");
    println!("   - Key: RSA-2048 (FIPS-approved)");
    println!("   - Hash: SHA-256 (FIPS-approved)");
    println!("   - Signature: sha256WithRSAEncryption (FIPS-approved)");
    println!("\n‚úÖ FIPS 140-2 compliance requirements satisfied");
}
